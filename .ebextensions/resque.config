packages:
  yum:
    monit: []

files:
  "/etc/monit.d/resque_worker":
    mode: "000644"
    owner: root
    group: root
    content: |
      check process resque_worker_QUEUE
        with pidfile /var/app/resque_worker_QUEUE.pid
        start program = "/bin/sh -l -c 'cd /var/app/current; nohup rake environment resque:work QUEUE=* VERBOSE=1 PIDFILE=/var/app/resque_worker_QUEUE.pid >> log/resque_worker_QUEUE.log 2>&1'" as uid webapp and gid webapp
        stop program = "/bin/sh -c 'cd /var/app/current && kill -9 $(cat tmp/pids/resque_worker_QUEUE.pid) && rm -f /var/app/resque_worker_QUEUE.pid; exit 0;'"
        if totalmem is greater than 300 MB for 10 cycles then restart  # eating up memory?
        group resque_workers

commands:
  remove_bak:
    command: "rm /etc/monit.d/resque_worker.bak"
    ignoreErrors: true

service:
  sysvinit:
    monit:
      ensureRunning: true
      enabled: true
# container_commands:
#   01resque:
#     command: bundle exec rake resque:restart_workers
#     ignoreErrors: true
# # commands:
# #   create_post_dir:
# #     command: "mkdir /opt/elasticbeanstalk/hooks/appdeploy/post"
# #     ignoreErrors: true
# # files:
# #   "/opt/elasticbeanstalk/hooks/appdeploy/post/99_resque_scheduler.sh":
# #     mode: "000755"
# #     owner: root
# #     group: root
# #     content: |
# #       #!/usr/bin/env bash
# #       . /opt/elasticbeanstalk/support/envvars
# #       cd $EB_CONFIG_APP_CURRENT
# #       su -c "rake resque:restart_scheduler RAILS_ENV=$RACK_ENV" $EB_CONFIG_APP_USER
